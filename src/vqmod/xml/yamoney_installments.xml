<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <id>yamoney_installments</id>
    <version>1.4.x and above</version>
    <vqmver required="true">2.6.0</vqmver>
    <author>Yandex.Money</author>


    <file name="admin/controller/sale/order.php" error="skip">
        <operation error="skip" info="Add Capture Link">
            <search position="after"><![CDATA[$action = array();]]></search>
            <add><![CDATA[
            $ya_kassa_hold_order_status = $this->config->get('ya_kassa_hold_order_status');
            $this->load->model('localisation/order_status');
            $this->language->load('payment/yamoney');
            foreach($this->model_localisation_order_status->getOrderStatuses() as $order_status) {
                if ($order_status['name'] !== $result['status']) {
                    continue;
                }
                if ($order_status['order_status_id'] !== $ya_kassa_hold_order_status) {
                    continue;
                }
                $action[] = array(
                    'text' => $this->language->get('kassa_hold_capture_form_link'),
                    'href' => $this->url->link('payment/yamoney/captureForm', 'token=' . $this->session->data['token'] . '&order_id=' . $result['order_id'] . $url, 'SSL')
                );
            }
            ]]></add>
        </operation>
    </file>

    <file name="catalog/controller/product/product.php" error="skip">
        <operation error="skip" info="Add Credit info flag">
            <search position="replace"><![CDATA[$product_info = $this->model_catalog_product->getProduct($product_id);]]></search>
            <add><![CDATA[
                $product_info = $this->model_catalog_product->getProduct($product_id);
                $paymentOptions = (array)$this->config->get('ya_kassa_payment_options');
                $enableCreditInEpl = $this->config->get('ya_kassa_payment_mode') === 'kassa' && $this->config->get('ya_kassa_add_installments_button');
                $enableCreditInShopSide = $this->config->get('ya_kassa_payment_mode') === 'shop' && in_array('installments', $paymentOptions);
                $showCreditInfo = $this->config->get('ya_kassa_enable') && ($enableCreditInEpl || $enableCreditInShopSide);

                $this->data['yamoney_showCreditInfo'] = $showCreditInfo;
                $this->data['yamoney_shop_id'] = $this->config->get('ya_shopid');
                $this->data['yamoney_credit_price'] = $this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax'));
                $this->data['yamoney_language_code'] = $this->config->get('config_language');
            ]]></add>
        </operation>
    </file>

    <file name="catalog/view/theme/*/template/common/header.tpl" error="skip">
        <operation error="skip" info="Add Credit UI">
            <search position="before"><![CDATA[</head>]]></search>
            <add><![CDATA[
                <script src="https://static.yandex.net/kassa/pay-in-parts/ui/v1/"></script>
            ]]></add>
        </operation>
    </file>

    <file name="catalog/view/theme/*/template/product/product.tpl" error="skip">
        <operation error="skip" info="Add Credit info template">
            <search position="before"><![CDATA[<div class="cart">]]></search>
            <add><![CDATA[
                <?php if($yamoney_showCreditInfo):?>
                    <div>
                        <div class="installments-info"></div>
                    </div>
                    <br>
                <?php endif;?>
            ]]></add>
        </operation>
        <operation error="skip" info="Add Credit UI">
            <search position="before"><![CDATA[<?php echo $footer; ?>]]></search>
            <add><![CDATA[
                <script>
                    if (typeof YandexCheckoutCreditUI !== "undefined") {
                        const $yamoneyCheckoutCreditUI = YandexCheckoutCreditUI({
                            shopId: '<?php echo $yamoney_shop_id;?>',
                            sum: '<?php echo round($yamoney_credit_price, 2);?>',
                            language: '<?php echo $yamoney_language_code;?>'
                        });

                        const yamoneyCheckoutCreditButton = $yamoneyCheckoutCreditUI({
                            type: 'info',
                            domSelector: '.installments-info'
                        });
                    }
                </script>
            ]]></add>
        </operation>
    </file>

</modification>